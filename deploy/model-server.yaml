---
AWSTemplateFormatVersion: "2010-09-09"

Description: "The training and deployment pipeline for a Machine Learning model API"

Parameters:
  ProductName:
    Description: Project name (also used as a tag for cost-tracking purposes)
    Type: String
  ServiceName:
    Description: Service name (also used as a tag for cost-tracking purposes)
    Type: String
  EnvironmentName:
    Description: Environment name (also used as a tag for cost-tracking purposes)
    Type: String

# Mappings:
#   set of mappings

# Conditions:
#   set of conditions

Resources:
  DataSourceBucket:
    Type: AWS::S3::Bucket
    Properties: 
      BucketName: !Join
        - '-'
        - - !Ref ServiceName
          - !Ref EnvironmentName
          - !Ref "AWS::Region"
          - !Ref "AWS::AccountId"
      LifecycleConfiguration:
        Rules: 
          - NoncurrentVersionExpirationInDays: 90
            Status: "Enabled"
      Tags: 
        - 
          Key: "product"
          Value: !Ref ProductName
        - 
          Key: "service"
          Value: !Ref ServiceName
        - 
          Key: "stage"
          Value: !Ref EnvironmentName
      VersioningConfiguration: 
        Status: "Enabled"
  # NewSourceDataEvent:
  #   Type: AWS::Events::Rule
  #   Properties: 
  #     Description: "An event signifying that new data has been uploaded to the training data bucket"
  #     EventPattern: Json
  #     Name: String
  #     RoleArn: String
  #     ScheduleExpression: String
  #     State: String
  #     Targets: 
  #       - Target
  EcrRepository:
    Type: AWS::ECR::Repository
    Properties: 
      LifecyclePolicy: 
        LifecyclePolicyText: |
          {
            "rules": [
            {
              "rulePriority": 1,
              "description": "Only keep a set number of images",
              "selection": {
                "tagStatus": "any",
                "countType": "imageCountMoreThan",
                "countNumber": 10
              },
              "action": { "type": "expire" }
            }]
          }
      RepositoryName: !Join
        - '-'
        - - !Ref ProductName
          - !Ref ServiceName
          - !Ref EnvironmentName
      Tags: 
        - 
          Key: "product"
          Value: !Ref ProductName
        - 
          Key: "service"
          Value: !Ref ServiceName
        - 
          Key: "stage"
          Value: !Ref EnvironmentName

# Outputs:
#   set of outputs